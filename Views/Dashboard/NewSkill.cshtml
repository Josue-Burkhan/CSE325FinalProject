@{
    ViewData["Title"] = "New Goal";
    Layout = null; // Full screen wizard, no sidebar
}

<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - SkillTracker</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2dd7cc",
                        "primary-dark": "#24b3aa",
                        "background-light": "#f9fafb",
                        "background-dark": "#191b1f",
                        "surface-light": "#ffffff",
                        "surface-dark": "#23262b",
                        "text-main": "#121717",
                        "text-secondary": "#658684",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"],
                    },
                },
            },
        }
    </script>
    <style>
        /* Step transitions */
        .step-container { 
            transition: opacity 0.4s ease, transform 0.4s ease; 
        }
        .step-hidden { 
            opacity: 0; 
            transform: translateY(20px); 
            pointer-events: none;
            position: absolute;
        }
        .step-visible { 
            opacity: 1; 
            transform: translateY(0); 
        }
        
        /* Typing animation for AI */
        .typing-dot {
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @@keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-4px); }
        }
        
        /* Progress bar animation */
        .progress-fill {
            transition: width 0.5s ease;
        }
        
        /* Chat bubble animation */
        .chat-bubble {
            animation: bubbleIn 0.3s ease forwards;
        }
        @@keyframes bubbleIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-main dark:text-white font-display min-h-screen flex flex-col">
    
    <!-- Header with close and progress -->
    <header class="fixed top-0 left-0 right-0 z-50 px-6 py-4 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md">
        <div class="max-w-2xl mx-auto flex items-center justify-between">
            <a asp-controller="Dashboard" asp-action="Index" class="flex items-center gap-2 text-text-secondary hover:text-text-main dark:hover:text-white transition-colors group">
                <span class="material-symbols-outlined group-hover:-translate-x-1 transition-transform">arrow_back</span>
                <span class="text-sm font-medium">Back</span>
            </a>
            
            <!-- Progress indicator -->
            <div class="flex items-center gap-3">
                <span class="text-xs font-bold text-text-secondary" id="step-indicator">Step 1 of 3</span>
                <div class="w-24 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                    <div class="progress-fill h-full bg-primary rounded-full" id="progress-bar" style="width: 33%"></div>
                </div>
            </div>
            
            <a asp-controller="Dashboard" asp-action="Index" class="text-text-secondary hover:text-text-main dark:hover:text-white transition-colors">
                <span class="material-symbols-outlined">close</span>
            </a>
        </div>
    </header>

    <!-- Main wizard container -->
    <main class="flex-1 flex items-center justify-center px-6 py-24">
        <div class="w-full max-w-2xl relative">
            
            <!-- Step 1: What's your goal? -->
            <div id="step-1" class="step-container step-visible">
                <div class="text-center mb-10">
                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-primary/10 text-primary rounded-full mb-6">
                        <span class="material-symbols-outlined text-lg">rocket_launch</span>
                        <span class="text-sm font-bold">New Journey</span>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-black tracking-tight mb-4">
                        Congrats on wanting to<br>
                        <span class="text-primary">grow!</span>
                    </h1>
                    <p class="text-lg text-text-secondary dark:text-gray-400">
                        Tell me, what new skill, knowledge, or goal do you want to achieve?
                    </p>
                </div>
                
                <div class="space-y-4">
                    <textarea 
                        id="goal-input"
                        class="w-full min-h-[140px] p-6 rounded-2xl bg-white dark:bg-surface-dark border-2 border-gray-100 dark:border-gray-700 focus:border-primary focus:ring-0 text-lg text-text-main dark:text-white placeholder:text-text-secondary/50 resize-none transition-all shadow-sm focus:shadow-lg outline-none"
                        placeholder="E.g., I want to learn to play guitar from scratch, be able to play my favorite songs..."
                    ></textarea>
                    
                    <div class="flex flex-wrap gap-2">
                        <span class="text-xs text-text-secondary">Ideas:</span>
                        <button type="button" class="suggestion-chip px-3 py-1 text-xs font-medium bg-gray-100 dark:bg-gray-800 text-text-secondary hover:text-primary hover:bg-primary/10 rounded-full transition-all">
                            Learn a language
                        </button>
                        <button type="button" class="suggestion-chip px-3 py-1 text-xs font-medium bg-gray-100 dark:bg-gray-800 text-text-secondary hover:text-primary hover:bg-primary/10 rounded-full transition-all">
                            Programming
                        </button>
                        <button type="button" class="suggestion-chip px-3 py-1 text-xs font-medium bg-gray-100 dark:bg-gray-800 text-text-secondary hover:text-primary hover:bg-primary/10 rounded-full transition-all">
                            Musical instrument
                        </button>
                        <button type="button" class="suggestion-chip px-3 py-1 text-xs font-medium bg-gray-100 dark:bg-gray-800 text-text-secondary hover:text-primary hover:bg-primary/10 rounded-full transition-all">
                            Fitness
                        </button>
                    </div>
                </div>
                
                <div class="mt-10 flex justify-end">
                    <button type="button" onclick="goToStep(2)" class="flex items-center gap-2 px-8 py-4 bg-primary hover:bg-primary-dark text-text-main font-bold text-lg rounded-xl shadow-lg shadow-primary/20 hover:shadow-primary/40 transition-all transform hover:-translate-y-0.5 active:scale-95">
                        Continue
                        <span class="material-symbols-outlined">arrow_forward</span>
                    </button>
                </div>
            </div>

            <!-- Step 2: When do you want to achieve it? -->
            <div id="step-2" class="step-container step-hidden">
                <div class="text-center mb-10">
                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 rounded-full mb-6">
                        <span class="material-symbols-outlined text-lg">calendar_month</span>
                        <span class="text-sm font-bold">Target Date</span>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-black tracking-tight mb-4">
                        When do you want to<br>
                        <span class="text-primary">achieve it?</span>
                    </h1>
                    <p class="text-lg text-text-secondary dark:text-gray-400">
                        Set a realistic date to reach your goal.
                    </p>
                </div>
                
                <div class="space-y-6">
                    <!-- Quick options -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button type="button" class="date-quick-btn p-4 rounded-xl bg-white dark:bg-surface-dark border-2 border-gray-100 dark:border-gray-700 hover:border-primary focus:border-primary transition-all text-center group" data-months="1">
                            <div class="text-2xl font-black text-text-main dark:text-white group-hover:text-primary transition-colors">1</div>
                            <div class="text-xs font-medium text-text-secondary">month</div>
                        </button>
                        <button type="button" class="date-quick-btn p-4 rounded-xl bg-white dark:bg-surface-dark border-2 border-gray-100 dark:border-gray-700 hover:border-primary focus:border-primary transition-all text-center group" data-months="3">
                            <div class="text-2xl font-black text-text-main dark:text-white group-hover:text-primary transition-colors">3</div>
                            <div class="text-xs font-medium text-text-secondary">months</div>
                        </button>
                        <button type="button" class="date-quick-btn p-4 rounded-xl bg-white dark:bg-surface-dark border-2 border-gray-100 dark:border-gray-700 hover:border-primary focus:border-primary transition-all text-center group" data-months="6">
                            <div class="text-2xl font-black text-text-main dark:text-white group-hover:text-primary transition-colors">6</div>
                            <div class="text-xs font-medium text-text-secondary">months</div>
                        </button>
                        <button type="button" class="date-quick-btn p-4 rounded-xl bg-white dark:bg-surface-dark border-2 border-gray-100 dark:border-gray-700 hover:border-primary focus:border-primary transition-all text-center group" data-months="12">
                            <div class="text-2xl font-black text-text-main dark:text-white group-hover:text-primary transition-colors">1</div>
                            <div class="text-xs font-medium text-text-secondary">year</div>
                        </button>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
                        <span class="text-xs font-medium text-text-secondary">or choose a specific date</span>
                        <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
                    </div>
                    
                    <div class="flex justify-center">
                        <input 
                            type="date" 
                            id="target-date"
                            class="px-6 py-4 rounded-xl bg-white dark:bg-surface-dark border-2 border-gray-100 dark:border-gray-700 focus:border-primary focus:ring-0 text-lg font-medium text-text-main dark:text-white transition-all"
                        />
                    </div>
                </div>
                
                <div class="mt-10 flex justify-between">
                    <button type="button" onclick="goToStep(1)" class="flex items-center gap-2 px-6 py-4 text-text-secondary hover:text-text-main dark:hover:text-white font-medium transition-colors">
                        <span class="material-symbols-outlined">arrow_back</span>
                        Back
                    </button>
                    <button type="button" onclick="goToStep(3)" class="flex items-center gap-2 px-8 py-4 bg-primary hover:bg-primary-dark text-text-main font-bold text-lg rounded-xl shadow-lg shadow-primary/20 hover:shadow-primary/40 transition-all transform hover:-translate-y-0.5 active:scale-95">
                        Continue
                        <span class="material-symbols-outlined">arrow_forward</span>
                    </button>
                </div>
            </div>

            <!-- Step 3: How much time can you dedicate? -->
            <div id="step-3" class="step-container step-hidden">
                <div class="text-center mb-10">
                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-violet-100 dark:bg-violet-900/30 text-violet-600 dark:text-violet-400 rounded-full mb-6">
                        <span class="material-symbols-outlined text-lg">schedule</span>
                        <span class="text-sm font-bold">Dedication</span>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-black tracking-tight mb-4">
                        How much time can you<br>
                        <span class="text-primary">dedicate?</span>
                    </h1>
                    <p class="text-lg text-text-secondary dark:text-gray-400">
                        This will help us create a realistic plan for you.
                    </p>
                </div>
                
                <div class="space-y-8">
                    <!-- Frequency selection -->
                    <div>
                        <label class="text-sm font-bold text-text-secondary uppercase tracking-wider mb-3 block">Frequency</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button type="button" class="frequency-btn p-4 rounded-xl bg-white dark:bg-surface-dark border-2 border-gray-100 dark:border-gray-700 hover:border-primary transition-all text-center" data-freq="daily">
                                <span class="material-symbols-outlined text-2xl mb-1 text-text-secondary">today</span>
                                <div class="text-sm font-bold text-text-main dark:text-white">Daily</div>
                            </button>
                            <button type="button" class="frequency-btn p-4 rounded-xl bg-white dark:bg-surface-dark border-2 border-primary transition-all text-center selected" data-freq="weekly">
                                <span class="material-symbols-outlined text-2xl mb-1 text-primary">date_range</span>
                                <div class="text-sm font-bold text-text-main dark:text-white">Weekly</div>
                            </button>
                            <button type="button" class="frequency-btn p-4 rounded-xl bg-white dark:bg-surface-dark border-2 border-gray-100 dark:border-gray-700 hover:border-primary transition-all text-center" data-freq="monthly">
                                <span class="material-symbols-outlined text-2xl mb-1 text-text-secondary">calendar_month</span>
                                <div class="text-sm font-bold text-text-main dark:text-white">Monthly</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Hours selection -->
                    <div>
                        <label class="text-sm font-bold text-text-secondary uppercase tracking-wider mb-3 block">Hours per <span id="freq-label">week</span></label>
                        <div class="flex items-center justify-center gap-4">
                            <button type="button" onclick="adjustHours(-1)" class="p-3 rounded-full bg-gray-100 dark:bg-gray-800 text-text-secondary hover:text-primary hover:bg-primary/10 transition-all">
                                <span class="material-symbols-outlined">remove</span>
                            </button>
                            <div class="w-32 text-center">
                                <input type="number" id="hours-input" value="5" min="1" max="40" class="w-full text-center bg-transparent border-none text-5xl font-black text-text-main dark:text-white focus:ring-0">
                                <div class="text-sm font-medium text-text-secondary">hours</div>
                            </div>
                            <button type="button" onclick="adjustHours(1)" class="p-3 rounded-full bg-gray-100 dark:bg-gray-800 text-text-secondary hover:text-primary hover:bg-primary/10 transition-all">
                                <span class="material-symbols-outlined">add</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Preferred time of day -->
                    <div>
                        <label class="text-sm font-bold text-text-secondary uppercase tracking-wider mb-3 block">Preferred Time</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button type="button" class="timeslot-btn p-3 rounded-xl bg-white dark:bg-surface-dark border-2 border-gray-100 dark:border-gray-700 hover:border-primary transition-all text-center" data-slot="morning">
                                <span class="text-xl mb-1">üåÖ</span>
                                <div class="text-xs font-medium text-text-main dark:text-white">Morning</div>
                            </button>
                            <button type="button" class="timeslot-btn p-3 rounded-xl bg-white dark:bg-surface-dark border-2 border-primary transition-all text-center selected" data-slot="afternoon">
                                <span class="text-xl mb-1">‚òÄÔ∏è</span>
                                <div class="text-xs font-medium text-text-main dark:text-white">Afternoon</div>
                            </button>
                            <button type="button" class="timeslot-btn p-3 rounded-xl bg-white dark:bg-surface-dark border-2 border-gray-100 dark:border-gray-700 hover:border-primary transition-all text-center" data-slot="evening">
                                <span class="text-xl mb-1">üåô</span>
                                <div class="text-xs font-medium text-text-main dark:text-white">Evening</div>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-10 flex justify-between">
                    <button type="button" onclick="goToStep(2)" class="flex items-center gap-2 px-6 py-4 text-text-secondary hover:text-text-main dark:hover:text-white font-medium transition-colors">
                        <span class="material-symbols-outlined">arrow_back</span>
                        Back
                    </button>
                    <button type="button" onclick="submitToAI()" id="submit-btn" class="flex items-center gap-2 px-8 py-4 bg-primary hover:bg-primary-dark text-text-main font-bold text-lg rounded-xl shadow-lg shadow-primary/20 hover:shadow-primary/40 transition-all transform hover:-translate-y-0.5 active:scale-95">
                        <span class="material-symbols-outlined">auto_awesome</span>
                        Generate My Plan
                    </button>
                </div>
            </div>

            <!-- Step 4: AI Processing / Clarification -->
            <div id="step-ai" class="step-container step-hidden">
                <div class="space-y-6">
                    <!-- AI Avatar and conversation -->
                    <div class="flex flex-col items-center mb-8">
                        <div class="w-20 h-20 rounded-full bg-gradient-to-br from-primary to-emerald-400 flex items-center justify-center shadow-lg shadow-primary/30 mb-4">
                            <span class="material-symbols-outlined text-4xl text-white">psychology</span>
                        </div>
                        <h2 class="text-2xl font-bold text-text-main dark:text-white">SkillTracker Assistant</h2>
                        <p class="text-text-secondary text-sm">Analyzing your goal...</p>
                    </div>
                    
                    <!-- Chat container -->
                    <div id="ai-chat-container" class="space-y-4 max-h-[400px] overflow-y-auto px-2">
                        <!-- AI messages will be inserted here -->
                    </div>
                    
                    <!-- User input for clarification (hidden initially) -->
                    <div id="clarification-input-container" class="hidden">
                        <div class="flex gap-3">
                            <input 
                                type="text" 
                                id="clarification-input"
                                class="flex-1 px-5 py-4 rounded-xl bg-white dark:bg-surface-dark border-2 border-gray-100 dark:border-gray-700 focus:border-primary focus:ring-0 text-base text-text-main dark:text-white placeholder:text-text-secondary/50 transition-all"
                                placeholder="Type your response..."
                            />
                            <button type="button" onclick="sendClarification()" class="px-5 py-4 bg-primary hover:bg-primary-dark text-text-main font-bold rounded-xl transition-all">
                                <span class="material-symbols-outlined">send</span>
                            </button>
                        </div>
                        <p id="clarification-counter" class="text-xs text-text-secondary mt-2 text-center"></p>
                    </div>
                </div>
            </div>

            <!-- Step 5: Plan Generated (Success) -->
            <div id="step-success" class="step-container step-hidden">
                <div class="text-center mb-8">
                    <div class="w-24 h-24 rounded-full bg-gradient-to-br from-primary to-emerald-400 flex items-center justify-center mx-auto mb-6 shadow-lg shadow-primary/30">
                        <span class="material-symbols-outlined text-5xl text-white">check_circle</span>
                    </div>
                    <h1 class="text-4xl font-black tracking-tight mb-4 text-text-main dark:text-white">
                        Your plan is ready!
                    </h1>
                    <p class="text-lg text-text-secondary dark:text-gray-400">
                        I've created a personalized plan to help you reach your goal.
                    </p>
                </div>
                
                <!-- Plan preview -->
                <div id="plan-preview" class="bg-white dark:bg-surface-dark rounded-2xl p-6 border border-gray-100 dark:border-gray-700 shadow-lg mb-8">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="material-symbols-outlined text-primary">flag</span>
                        <h3 class="text-lg font-bold text-text-main dark:text-white" id="preview-goal-title">Your goal</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <span class="material-symbols-outlined text-amber-500">calendar_today</span>
                            <div>
                                <div class="text-xs text-text-secondary uppercase font-bold">Target Date</div>
                                <div class="font-medium text-text-main dark:text-white" id="preview-date">--</div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <span class="material-symbols-outlined text-violet-500">timer</span>
                            <div>
                                <div class="text-xs text-text-secondary uppercase font-bold">Dedication</div>
                                <div class="font-medium text-text-main dark:text-white" id="preview-dedication">--</div>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-100 dark:border-gray-700 pt-4">
                            <div class="text-xs text-text-secondary uppercase font-bold mb-3">AI-Suggested Milestones</div>
                            <div id="preview-milestones" class="space-y-2">
                                <!-- AI-generated milestones will be here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button type="button" onclick="savePlan()" id="save-plan-btn" class="flex items-center justify-center gap-2 px-8 py-4 bg-primary hover:bg-primary-dark text-text-main font-bold text-lg rounded-xl shadow-lg shadow-primary/20 hover:shadow-primary/40 transition-all">
                        <span class="material-symbols-outlined">rocket_launch</span>
                        Save & Start Now!
                    </button>
                    <button type="button" onclick="goToStep(1); currentPlan = null;" class="flex items-center justify-center gap-2 px-8 py-4 border-2 border-gray-200 dark:border-gray-700 text-text-main dark:text-white font-bold rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        Create Another Goal
                    </button>
                </div>
            </div>

        </div>
    </main>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            currentStep: 1,
            goalDescription: '',
            targetDate: '',
            dedication: {
                frequency: 'weekly',
                hoursPerPeriod: 5,
                preferredTimeSlot: 'afternoon'
            },
            clarifications: [],
            maxClarifications: 2,
            clarificationCount: 0
        };

        // ============================================
        // STEP NAVIGATION
        // ============================================
        function goToStep(stepNum) {
            // Validate before moving forward
            if (stepNum > state.currentStep) {
                if (state.currentStep === 1 && !validateStep1()) return;
                if (state.currentStep === 2 && !validateStep2()) return;
                if (state.currentStep === 3 && !validateStep3()) return;
            }
            
            // Hide current step
            document.getElementById(`step-${state.currentStep}`).classList.remove('step-visible');
            document.getElementById(`step-${state.currentStep}`).classList.add('step-hidden');
            
            // Show new step
            state.currentStep = stepNum;
            const targetStep = stepNum === 4 ? 'step-ai' : stepNum === 5 ? 'step-success' : `step-${stepNum}`;
            document.getElementById(targetStep).classList.remove('step-hidden');
            document.getElementById(targetStep).classList.add('step-visible');
            
            // Update progress
            updateProgress();
        }

        function updateProgress() {
            const progressBar = document.getElementById('progress-bar');
            const stepIndicator = document.getElementById('step-indicator');
            
            if (state.currentStep <= 3) {
                progressBar.style.width = `${(state.currentStep / 3) * 100}%`;
                stepIndicator.textContent = `Step ${state.currentStep} of 3`;
            } else {
                progressBar.style.width = '100%';
                stepIndicator.textContent = state.currentStep === 4 ? 'Processing...' : 'Completed!';
            }
        }

        // ============================================
        // VALIDATION
        // ============================================
        function validateStep1() {
            const input = document.getElementById('goal-input');
            state.goalDescription = input.value.trim();
            
            if (state.goalDescription.length < 10) {
                input.classList.add('border-red-400');
                input.placeholder = 'Please describe your goal in more detail...';
                return false;
            }
            input.classList.remove('border-red-400');
            return true;
        }

        function validateStep2() {
            const dateInput = document.getElementById('target-date');
            if (!dateInput.value) {
                // Check if quick button was selected
                const selected = document.querySelector('.date-quick-btn.selected');
                if (!selected) {
                    alert('Please select a target date');
                    return false;
                }
            }
            state.targetDate = dateInput.value || calculateDateFromMonths(
                document.querySelector('.date-quick-btn.selected')?.dataset.months || 3
            );
            return true;
        }

        function validateStep3() {
            state.dedication.hoursPerPeriod = parseInt(document.getElementById('hours-input').value) || 5;
            return true;
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function calculateDateFromMonths(months) {
            const date = new Date();
            date.setMonth(date.getMonth() + parseInt(months));
            return date.toISOString().split('T')[0];
        }

        function adjustHours(delta) {
            const input = document.getElementById('hours-input');
            let value = parseInt(input.value) + delta;
            value = Math.max(1, Math.min(40, value));
            input.value = value;
            state.dedication.hoursPerPeriod = value;
        }

        // ============================================
        // UI INTERACTIONS
        // ============================================
        
        // Suggestion chips
        document.querySelectorAll('.suggestion-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.getElementById('goal-input').value = chip.textContent.trim();
            });
        });

        // Date quick buttons
        document.querySelectorAll('.date-quick-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.date-quick-btn').forEach(b => b.classList.remove('selected', 'border-primary'));
                btn.classList.add('selected', 'border-primary');
                document.getElementById('target-date').value = calculateDateFromMonths(btn.dataset.months);
            });
        });

        // Frequency buttons
        document.querySelectorAll('.frequency-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.frequency-btn').forEach(b => {
                    b.classList.remove('selected');
                    b.classList.remove('border-primary');
                    b.classList.add('border-gray-100', 'dark:border-gray-700');
                    b.querySelector('.material-symbols-outlined').classList.remove('text-primary');
                    b.querySelector('.material-symbols-outlined').classList.add('text-text-secondary');
                });
                btn.classList.add('selected', 'border-primary');
                btn.classList.remove('border-gray-100', 'dark:border-gray-700');
                btn.querySelector('.material-symbols-outlined').classList.add('text-primary');
                btn.querySelector('.material-symbols-outlined').classList.remove('text-text-secondary');
                
                state.dedication.frequency = btn.dataset.freq;
                const labels = { daily: 'day', weekly: 'week', monthly: 'month' };
                document.getElementById('freq-label').textContent = labels[btn.dataset.freq];
            });
        });

        // Timeslot buttons
        document.querySelectorAll('.timeslot-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.timeslot-btn').forEach(b => {
                    b.classList.remove('selected', 'border-primary');
                    b.classList.add('border-gray-100', 'dark:border-gray-700');
                });
                btn.classList.add('selected', 'border-primary');
                btn.classList.remove('border-gray-100', 'dark:border-gray-700');
                state.dedication.preferredTimeSlot = btn.dataset.slot;
            });
        });

        // ============================================
        // AI INTEGRATION (FUNCTIONAL)
        // ============================================
        
        let currentPlan = null;
        let pendingClarificationQuestion = '';
        
        function submitToAI() {
            if (!validateStep3()) return;
            
            goToStep(4);
            state.clarifications = []; // Reset clarifications
            state.clarificationCount = 0;
            
            // Clear previous chat
            document.getElementById('ai-chat-container').innerHTML = '';
            document.getElementById('clarification-input-container').classList.add('hidden');
            
            // Show initial AI processing message
            addAIMessage('Analyzing your goal...', true);
            
            // Call AI API
            setTimeout(() => {
                callAIApi();
            }, 500);
        }

        async function callAIApi() {
            const payload = {
                goalDescription: state.goalDescription,
                targetDate: state.targetDate,
                frequency: state.dedication.frequency,
                hoursPerPeriod: state.dedication.hoursPerPeriod,
                preferredTimeSlot: state.dedication.preferredTimeSlot,
                clarifications: state.clarifications
            };
            
            console.log('Sending to AI API:', payload);
            
            try {
                const response = await fetch('/api/ai/generate-plan', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });
                
                const result = await response.json();
                console.log('AI API Response:', result);
                
                // Remove typing indicator
                document.querySelector('.typing-indicator')?.remove();
                
                if (!response.ok || !result.success) {
                    addAIMessage(`Sorry, there was an error: ${result.message || 'Failed to generate plan'}. Please try again.`);
                    return;
                }
                
                handleAIResponse(result.data);
                
            } catch (error) {
                console.error('AI API Error:', error);
                document.querySelector('.typing-indicator')?.remove();
                addAIMessage('Sorry, there was a connection error. Please check your internet and try again.');
            }
        }
        
        function handleAIResponse(data) {
            if (data.needsClarification && data.clarificationQuestion) {
                // AI needs more info
                pendingClarificationQuestion = data.clarificationQuestion;
                addAIMessage(data.clarificationQuestion);
                showClarificationInput();
            } else if (data.plan) {
                // Plan is ready!
                currentPlan = data.plan;
                addAIMessage(`Great! I've created a personalized plan for "${data.plan.skillName}". üéâ`);
                
                setTimeout(() => {
                    showSuccessStep(data.plan);
                }, 1500);
            } else {
                addAIMessage('Hmm, something went wrong. Let me try again...');
                setTimeout(() => callAIApi(), 2000);
            }
        }

        function addAIMessage(text, isTyping = false) {
            const container = document.getElementById('ai-chat-container');
            
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble flex gap-3';
            
            if (isTyping) {
                bubble.classList.add('typing-indicator');
                bubble.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-emerald-400 flex items-center justify-center flex-shrink-0">
                        <span class="material-symbols-outlined text-white text-lg">psychology</span>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-800 rounded-2xl rounded-tl-md px-4 py-3 flex items-center gap-1">
                        <span class="typing-dot w-2 h-2 bg-text-secondary rounded-full"></span>
                        <span class="typing-dot w-2 h-2 bg-text-secondary rounded-full"></span>
                        <span class="typing-dot w-2 h-2 bg-text-secondary rounded-full"></span>
                    </div>
                `;
            } else {
                bubble.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-emerald-400 flex items-center justify-center flex-shrink-0">
                        <span class="material-symbols-outlined text-white text-lg">psychology</span>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-800 rounded-2xl rounded-tl-md px-4 py-3 max-w-[80%]">
                        <p class="text-text-main dark:text-white">${text}</p>
                    </div>
                `;
            }
            
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
        }

        function addUserMessage(text) {
            const container = document.getElementById('ai-chat-container');
            
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble flex gap-3 justify-end';
            bubble.innerHTML = `
                <div class="bg-primary/20 rounded-2xl rounded-tr-md px-4 py-3 max-w-[80%]">
                    <p class="text-text-main dark:text-white">${text}</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center flex-shrink-0">
                    <span class="material-symbols-outlined text-text-secondary text-lg">person</span>
                </div>
            `;
            
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
        }

        function showClarificationInput() {
            const container = document.getElementById('clarification-input-container');
            container.classList.remove('hidden');
            document.getElementById('clarification-counter').textContent = 
                `Question ${state.clarificationCount + 1} of ${state.maxClarifications} max`;
            document.getElementById('clarification-input').focus();
        }

        function sendClarification() {
            const input = document.getElementById('clarification-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            // Add user message to chat
            addUserMessage(text);
            
            // Save clarification
            state.clarifications.push({
                question: pendingClarificationQuestion,
                answer: text
            });
            state.clarificationCount++;
            
            // Clear input
            input.value = '';
            
            // Hide input if max clarifications reached
            if (state.clarificationCount >= state.maxClarifications) {
                document.getElementById('clarification-input-container').classList.add('hidden');
            }
            
            // Show typing and call API again
            addAIMessage('', true);
            setTimeout(() => {
                callAIApi();
            }, 500);
        }
        
        // Handle Enter key in clarification input
        document.getElementById('clarification-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendClarification();
            }
        });

        function showSuccessStep(plan) {
            // Update preview with plan data
            document.getElementById('preview-goal-title').textContent = plan.skillName || state.goalDescription.substring(0, 60);
            
            if (state.targetDate) {
                const dateObj = new Date(state.targetDate);
                document.getElementById('preview-date').textContent = dateObj.toLocaleDateString('en-US', { 
                    year: 'numeric', month: 'long', day: 'numeric' 
                });
            } else {
                document.getElementById('preview-date').textContent = 'Flexible';
            }
            
            const freqLabels = { daily: 'day', weekly: 'week', monthly: 'month' };
            document.getElementById('preview-dedication').textContent = 
                `${state.dedication.hoursPerPeriod} hours per ${freqLabels[state.dedication.frequency]}`;
            
            // Add goals/milestones from AI plan
            const milestonesContainer = document.getElementById('preview-milestones');
            
            if (plan.goals && plan.goals.length > 0) {
                milestonesContainer.innerHTML = plan.goals.map((goal, i) => `
                    <div class="flex items-center gap-3 p-2 rounded-lg ${i === 0 ? 'bg-primary/10' : ''}">
                        <div class="w-6 h-6 rounded-full ${i === 0 ? 'bg-primary' : 'bg-gray-200 dark:bg-gray-700'} flex items-center justify-center text-xs font-bold ${i === 0 ? 'text-white' : 'text-text-secondary'}">
                            ${i + 1}
                        </div>
                        <span class="text-sm font-medium text-text-main dark:text-white flex-1">${goal.title}</span>
                        <span class="text-xs text-text-secondary">Week ${goal.weekNumber || i + 1}</span>
                    </div>
                `).join('');
            } else {
                milestonesContainer.innerHTML = '<p class="text-sm text-text-secondary">No milestones generated</p>';
            }
            
            goToStep(5);
        }
        
        // ============================================
        // SAVE PLAN TO DATABASE
        // ============================================
        async function savePlan() {
            if (!currentPlan) {
                alert('No plan to save!');
                return;
            }
            
            const saveBtn = document.querySelector('#step-success a[class*="bg-primary"]');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span> Saving...';
            saveBtn.style.pointerEvents = 'none';
            
            try {
                const response = await fetch('/api/ai/apply-plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentPlan),
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    // Redirect to the new skill detail page
                    window.location.href = `/Dashboard/SkillDetail/${result.data.id}`;
                } else {
                    alert(result.message || 'Failed to save plan. Please try again.');
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.pointerEvents = 'auto';
                }
            } catch (error) {
                console.error('Error saving plan:', error);
                alert('Failed to save plan. Please try again.');
                saveBtn.innerHTML = originalText;
                saveBtn.style.pointerEvents = 'auto';
            }
        }

        // ============================================
        // THEME INITIALIZATION
        // ============================================
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                document.documentElement.classList.remove('light');
            }
        })();
    </script>
</body>
</html>
