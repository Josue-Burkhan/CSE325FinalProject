@page "/reports"
@page "/progress"
@attribute [Authorize]
@inject IProgressLogService ProgressLogService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Reports - SkillTracker</PageTitle>

<div class="max-w-[1400px] mx-auto flex flex-col gap-8">
    <header>
        <h1 class="text-3xl font-bold text-text-main dark:text-white">Progress Reports</h1>
        <p class="text-text-secondary dark:text-gray-400 mt-1">Track your learning journey over time</p>
    </header>
    
    @if (isLoading)
    {
        <div class="flex items-center justify-center py-16">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
        </div>
    }
    else
    {
        <!-- Stats Overview -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <StatsCard Icon="schedule" Title="Total Hours" Value="@($"{Math.Round(stats.TotalHoursAllTime, 1)}h")" Color="blue" />
            <StatsCard Icon="check_circle" Title="Goals Completed" Value="@stats.CompletedGoals.ToString()" Color="green" />
            <StatsCard Icon="local_fire_department" Title="Current Streak" Value="@($"{stats.CurrentStreak} days")" Color="orange" />
            <StatsCard Icon="trending_up" Title="This Week" Value="@($"{Math.Round(stats.TotalHoursThisWeek, 1)}h")" Color="primary" />
        </div>
        
        <!-- Weekly Activity Chart (Placeholder) -->
        <div class="bg-surface-light dark:bg-surface-dark rounded-2xl p-6 border border-gray-100 dark:border-gray-800">
            <h2 class="text-xl font-bold text-text-main dark:text-white mb-6">Weekly Activity</h2>
            <div class="h-64 flex items-end justify-between gap-2">
                @foreach (var week in weeklyActivity.Take(12))
                {
                    var maxHours = weeklyActivity.Any() ? weeklyActivity.Max(w => w.HoursLogged) : 1;
                    var heightBytes = maxHours > 0 ? Math.Max(10, (week.HoursLogged / (decimal)Math.Max(1, maxHours)) * 100) : 10;
                    var height = (int)heightBytes; // Casts to int to prevent locale-specific formatting issues in CSS style string
                    
                    <div class="flex-1 flex flex-col items-center gap-2 group relative">
                        <!-- Uses teal-500 for visibility and applies calculated height -->
                        <div class="w-full bg-teal-500 rounded-t-lg transition-all hover:bg-teal-600" style="height: @height%"></div>
                        <span class="text-xs text-text-secondary dark:text-gray-500 truncate">W@(week.WeekNumber)</span>
                        
                        <!-- Tooltip -->
                        <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10">
                            @week.WeekLabel: @Math.Round(week.HoursLogged, 1)h
                        </div>
                    </div>
                }
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="bg-surface-light dark:bg-surface-dark rounded-2xl p-6 border border-gray-100 dark:border-gray-800">
            <h2 class="text-xl font-bold text-text-main dark:text-white mb-6">Recent Activity</h2>
            @if (recentLogs.Any())
            {
                <div class="space-y-4">
                    @foreach (var log in recentLogs.Take(10))
                    {
                        <div class="flex items-center gap-4 p-4 bg-background-light dark:bg-background-dark rounded-lg">
                            <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined">history</span>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-text-main dark:text-white">@(log.Title ?? "Progress logged")</p>
                                <p class="text-sm text-text-secondary dark:text-gray-500">@log.SkillName Â· @log.LogDate.ToString("MMM dd, yyyy")</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-text-main dark:text-white">@log.HoursLogged h</p>
                                @if (log.QualityRating.HasValue)
                                {
                                    <div class="flex gap-0.5 justify-end">
                                        @for (int i = 0; i < 5; i++)
                                        {
                                            <span class="material-symbols-outlined text-[14px] @(i < log.QualityRating ? "text-yellow-400" : "text-gray-300 dark:text-gray-600")">star</span>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-8">
                    <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">history</span>
                    <p class="text-text-secondary dark:text-gray-400">No activity logged yet</p>
                </div>
            }
        </div>
    }
</div>

@code {
    private DashboardStatsDto stats = new();
    private List<WeeklyActivityDto> weeklyActivity = new();
    private List<ProgressLogDto> recentLogs = new();
    private bool isLoading = true;
    private int userId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userIdClaim = authState.User.FindFirst("userId")?.Value;
        
        if (int.TryParse(userIdClaim, out userId) && userId > 0)
        {
            stats = await ProgressLogService.GetDashboardStatsAsync(userId);
            weeklyActivity = await ProgressLogService.GetWeeklyActivityAsync(userId, 12);
            
            // Retrieves recent logs using the paginated API
            var logsResponse = await ProgressLogService.GetUserLogsAsync(userId, 1, 10);
            recentLogs = logsResponse.Items;
        }
        
        isLoading = false;
    }
}
